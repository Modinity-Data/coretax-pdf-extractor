<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coretax PDF Extractor (V9.1 - Stable)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.05.1/pyscript.css" />
    <script defer src="https://pyscript.net/releases/2023.05.1/pyscript.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>

    <script>
        function mark_ready() {
            const init = document.getElementById('init-state');
            const ready = document.getElementById('ready-state');
            if(init) init.classList.add('hidden');
            if(ready) ready.classList.remove('hidden');
        }
    </script>

    <style>
        py-terminal { display: none; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800">

    <div class="max-w-4xl mx-auto mt-10 p-6">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-slate-900">Coretax PDF Extractor</h1>
            <p class="text-sm text-slate-500 mt-2">Developed by Data Team | V9.1: Fix DPP Accuracy & Error Handler</p>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-8">
            
            <div id="init-state" class="text-center py-12">
                <div class="loader mb-4"></div>
                <h3 class="text-lg font-medium text-slate-700">Loading Python Engine...</h3>
            </div>

            <div id="ready-state" class="hidden">
                <div 
                    class="border-2 border-dashed border-indigo-300 bg-indigo-50 rounded-xl p-10 text-center cursor-pointer hover:bg-indigo-100 transition-colors group"
                    onclick="document.getElementById('fileInput').click()"
                >
                    <div class="text-indigo-500 mb-3 group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-slate-700">Upload PDF Files</h3>
                    <p class="text-xs text-slate-500 mt-1">Batch processing enabled (50 files/cycle).</p>
                    <input type="file" id="fileInput" multiple accept="application/pdf" class="hidden">
                </div>

                <div id="log-container" class="mt-6 hidden">
                    <div class="flex justify-between text-xs font-semibold text-slate-600 mb-1">
                        <span id="status-label">Processing...</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2 mb-4">
                        <div id="progress-bar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div id="console-output" class="bg-slate-900 text-green-400 text-xs font-mono p-3 rounded-lg h-32 overflow-y-auto"></div>
                </div>

                <div id="download-container" class="hidden mt-6 text-center">
                     <button onclick="window.trigger_download()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:-translate-y-1">
                        Download Excel Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <py-config>
        packages = ["pandas", "xlsxwriter"]
    </py-config>

    <py-script>
import pandas as pd
import re
import io
import base64
from js import window

extracted_data = []

def parse_date(date_str):
    if not date_str: return ""
    clean = date_str.lower().replace(',', '').strip()
    month_map = {
        'januari': '01', 'februari': '02', 'maret': '03', 'april': '04',
        'mei': '05', 'juni': '06', 'juli': '07', 'agustus': '08',
        'september': '09', 'oktober': '10', 'november': '11', 'desember': '12'
    }
    try:
        parts = clean.split()
        year = next((p for p in parts if len(p) == 4 and p.isdigit()), "")
        day = next((p for p in parts if len(p) <= 2 and p.isdigit()), "")
        if len(day) == 1: day = "0" + day
        month = "00"
        for p in parts:
            if p in month_map:
                month = month_map[p]
                break
        if year and month != "00" and day:
            return f"{year}-{month}-{day}"
    except: pass
    return date_str

def format_masa(text):
    m = re.search(r"\b([0-1][0-9]-20[2-3][0-9])\b", text)
    if m:
        parts = m.group(1).split('-')
        return f"{parts[1]}-{parts[0]}-01"
    return ""

def process_pdf_content(text, filename, index):
    try:
        # --- 1. HEADER ---
        header_text = text[:1200]
        nomor_match = re.search(r"\b(2[4-6][0-9A-Z]{7,15})\b", header_text)
        nomor = nomor_match.group(1) if nomor_match else ""
        masa_pajak = format_masa(header_text)
        
        status_bupot = "NORMAL"
        if re.search(r"\bPEMBETULAN\b", header_text, re.IGNORECASE):
            rev_match = re.search(r"(PEMBETULAN\s+KE\s*-\s*\d+)", header_text, re.IGNORECASE)
            status_bupot = rev_match.group(1).upper() if rev_match else "PEMBETULAN"

        # --- 2. FINANCIALS ---
        code_match = re.search(r"(\d{2}-\d{3}-\d{2})", text)
        kode_objek = code_match.group(1) if code_match else ""
        
        objek_pajak = ""
        dpp = 0
        tarif = 0
        pph = 0
        
        if kode_objek:
            # A. Find Object Name
            lines = text.split('\n')
            for line in lines:
                if kode_objek in line:
                    text_parts = re.findall(r"[A-Za-z\s,\(\)\.\/-]+", line.replace(kode_objek, ""))
                    valid_texts = [t.strip() for t in text_parts if len(t.strip()) > 3]
                    if valid_texts:
                        objek_pajak = valid_texts[0]
                    break
            
            # B. Define Strict Search Area
            code_idx = text.find(kode_objek)
            
            # Boundary check
            limit_idx_1 = text.find("C. IDENTITAS", code_idx)
            limit_idx_2 = text.find("Dokumen Dasar", code_idx)
            
            limit_idx = len(text)
            if limit_idx_1 != -1: limit_idx = min(limit_idx, limit_idx_1)
            if limit_idx_2 != -1: limit_idx = min(limit_idx, limit_idx_2)
            
            end_idx = min(code_idx + 400, limit_idx)
            scan_window = text[code_idx:end_idx]
            
            # C. Extract Numbers
            scan_window_clean = scan_window.replace(kode_objek, " ")
            raw_nums = re.findall(r"((?:\d{1,3}(?:\.\d{3})*)+(?:,\d+)?)", scan_window_clean)
            
            valid_floats = []
            for rs in raw_nums:
                # SKIP potential IDs
                if len(rs.replace('.','').replace(',','')) > 14 and '.' not in rs:
                    continue
                clean = rs.replace('.', '').replace(',', '.')
                try:
                    val = float(clean)
                    if val != 24 and val != 100: 
                        valid_floats.append(val)
                except: pass
            
            # D. Heuristic Assignment
            if len(valid_floats) >= 3:
                rates = [x for x in valid_floats if 0 < x <= 100]
                tarif = rates[0] if rates else 0
                if tarif in valid_floats: valid_floats.remove(tarif)
                if len(valid_floats) >= 2:
                    dpp = max(valid_floats)
                    valid_floats.remove(dpp)
                    if valid_floats: pph = max(valid_floats)
        
        # --- 3. IDENTITY ---
        npwp_match = re.search(r"C\.1.*?(\d{15,16})", text, re.DOTALL)
        npwp = npwp_match.group(1) if npwp_match else ""

        nitku_match = re.search(r"C\.2.*?(\d{16,22})", text, re.DOTALL)
        nitku = nitku_match.group(1) if nitku_match else ""

        nama_match = re.search(r"C\.3.*?:\s*([^\n]+)", text)
        nama_pemotong = nama_match.group(1).strip() if nama_match else ""

        tgl_match = re.search(r"C\.4.*?:\s*([^\n]+)", text)
        date_str = tgl_match.group(1).strip() if tgl_match else ""
        date_final = parse_date(date_str)

        ttd_match = re.search(r"C\.5.*?:\s*([^\n]+)", text)
        ttd = ttd_match.group(1).strip() if ttd_match else ""

        doc_match = re.search(r"Nomor Dokumen\s*[:\s]+([^\n]+)", text, re.IGNORECASE)
        no_dokumen = doc_match.group(1).strip() if doc_match else ""

        extracted_data.append({
            "NO": index,
            "NOMOR": nomor,
            "MASA PAJAK": masa_pajak,
            "SIFAT PEMOTONGAN DAN/ATAU PEMUNGUTAN PPh": "TIDAK FINAL",
            "STATUS BUKTI PEMOTONGAN / PEMUNGUTAN": status_bupot,
            "KODE OBJEK PAJAK": kode_objek,
            "OBJEK PAJAK": objek_pajak,
            "DPP": dpp,
            "TARIF": tarif,
            "PAJAK PENGHASILAN": pph,
            "NOMOR DOKUMEN": no_dokumen,
            "NPWP / NIK": npwp,
            "(NITKU)": nitku,
            "NAMA PEMOTONG": nama_pemotong,
            "DATE": date_final,
            "NAMA PENANDATANGAN": ttd
        })

        return f"Processed: {filename}"

    except Exception as e:
        return f"Error {filename}: {str(e)}"

def generate_excel():
    if not extracted_data: return None
    df = pd.DataFrame(extracted_data)
    cols = ["NO", "NOMOR", "MASA PAJAK", "SIFAT PEMOTONGAN DAN/ATAU PEMUNGUTAN PPh",
            "STATUS BUKTI PEMOTONGAN / PEMUNGUTAN", "KODE OBJEK PAJAK", "OBJEK PAJAK",
            "DPP", "TARIF", "PAJAK PENGHASILAN", "NOMOR DOKUMEN", "NPWP / NIK",
            "(NITKU)", "NAMA PEMOTONG", "DATE", "NAMA PENANDATANGAN"]
    for c in cols:
        if c not in df.columns: df[c] = ""
    
    str_cols = ["NOMOR", "NPWP / NIK", "(NITKU)", "NOMOR DOKUMEN"]
    for c in str_cols:
        df[c] = df[c].astype(str)

    buffer = io.BytesIO()
    with pd.ExcelWriter(buffer, engine='xlsxwriter') as writer:
        df[cols].to_excel(writer, index=False, sheet_name='Data')
        workbook = writer.book
        worksheet = writer.sheets['Data']
        num_fmt = workbook.add_format({'num_format': '#,##0'})
        text_fmt = workbook.add_format({'num_format': '@'})
        worksheet.set_column(7, 7, 20, num_fmt) 
        worksheet.set_column(9, 9, 20, num_fmt)
        worksheet.set_column(11, 12, 25, text_fmt)

    return base64.b64encode(buffer.getvalue()).decode()

def clear_buffer():
    extracted_data.clear()

# --- FIX: CALL JS FUNCTION CORRECTLY ---
window.process_pdf_content = process_pdf_content
window.generate_excel = generate_excel
window.clear_buffer = clear_buffer
window.mark_ready() 
    </py-script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

        const logBox = document.getElementById('console-output');
        const progressBar = document.getElementById('progress-bar');
        const percentText = document.getElementById('progress-percent');
        const statusLabel = document.getElementById('status-label');
        const downloadContainer = document.getElementById('download-container');
        let excelBase64 = null;

        function log(msg, error=false) {
            const el = document.createElement('div');
            el.innerText = "> " + msg;
            if (error) el.style.color = '#ef4444';
            logBox.appendChild(el);
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function extractSmartText(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                const pdf = await loadingTask.promise;
                const page = await pdf.getPage(1);
                const textContent = await page.getTextContent();
                page.cleanup();

                const items = textContent.items.map(item => ({
                    text: item.str, x: item.transform[4], y: item.transform[5]
                }));

                items.sort((a, b) => {
                    const yDiff = Math.abs(a.y - b.y);
                    if (yDiff < 5) return a.x - b.x;
                    return b.y - a.y;
                });

                let fullText = "";
                let lastY = -999;
                items.forEach(item => {
                    if (lastY !== -999 && Math.abs(item.y - lastY) > 5) fullText += "\n";
                    else if (lastY !== -999) fullText += " ";
                    fullText += item.text;
                    lastY = item.y;
                });

                await pdf.destroy();
                return fullText;
            } catch (err) {
                console.error("Extraction error:", err);
                throw err;
            }
        }

        function getFilename() {
            const now = new Date();
            const pad = (n) => String(n).padStart(2,'0');
            return `Tax_Recap_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.xlsx`;
        }

        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        document.getElementById('fileInput').addEventListener('change', async function() {
            const files = Array.from(this.files);
            if (!files.length) return;

            logBox.innerHTML = "";
            window.clear_buffer();
            downloadContainer.classList.add('hidden');
            document.getElementById('log-container').classList.remove('hidden');
            
            const BATCH_SIZE = 50; 
            const total = files.length;
            let processed = 0;

            for (let i = 0; i < total; i += BATCH_SIZE) {
                const batch = files.slice(i, i + BATCH_SIZE);
                statusLabel.innerText = `Processing batch ${Math.floor(i/BATCH_SIZE) + 1} (Files ${i+1}-${Math.min(i+BATCH_SIZE, total)})...`;
                
                for (const file of batch) {
                    try {
                        const text = await extractSmartText(file);
                        const msg = window.process_pdf_content(text, file.name, processed + 1);
                        log(msg);
                    } catch(e) {
                        log(`Error ${file.name}: ${e.message}`, true);
                    }
                    processed++;
                    const pct = Math.round((processed / total) * 100);
                    progressBar.style.width = pct + "%";
                    percentText.innerText = pct + "%";
                }

                if (processed < total) {
                    statusLabel.innerText = "Resting browser memory (1s)...";
                    await wait(1000); 
                }
            }

            statusLabel.innerText = "Finalizing Excel...";
            progressBar.style.width = "100%";
            percentText.innerText = "100%";
            
            const b64 = window.generate_excel();
            if (b64) {
                excelBase64 = b64;
                downloadContainer.classList.remove('hidden');
                log("Processing Complete. Ready to download.");
                window.trigger_download();
            }
        });

        window.trigger_download = function() {
            if(!excelBase64) return;
            const bin = atob(excelBase64);
            const bytes = new Uint8Array(bin.length);
            for(let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
            const blob = new Blob([bytes], {type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = getFilename();
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
